# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: CI/CD Golang Deploy to AWS EC2 with Rollback

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Golang
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.0'

    - name: Build Go Project
      run: |
        go mod tidy
        go build -o todolist-backend ./cmd/main.go
        echo "âœ… Build successful"

    - name: Deploy via SSH to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.AWS_EC2_HOST }}
        username: ${{ secrets.AWS_EC2_USER }}
        key: ${{ secrets.AWS_EC2_KEY }}
        script: |
          echo "ğŸš€ Deploying code to EC2..."
          cd /home/ubuntu/todolist-backend
          
          # Backup old version if the file exists
          if [ -f todolist-backend ]; then
            mv todolist-backend todolist-backend.bak
            echo "ğŸ—‚ï¸ Backup old version successful"
          fi
          
          # Upload new file from the temporary directory
          if [ -f ~/todolist-backend ]; then
            sudo mv ~/todolist-backend ./todolist-backend
            sudo chmod +x todolist-backend
            sudo systemctl restart todolist-backend.service
            echo "âœ… Deploy Successful"
          else
            echo "âŒ Deploy Failed, file not found!"
            if [ -f todolist-backend.bak ]; then
              mv todolist-backend.bak todolist-backend
              sudo systemctl restart todolist-backend.service
              echo "ğŸ”„ Rolled back to old version"
            else
              echo "ğŸš« No backup version found!"
            fi
            exit 1
          fi

