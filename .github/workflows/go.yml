# This workflow will build and deploy a Golang project to AWS EC2 without rollback
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: CI/CD Golang Deploy to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Checkout code from repo
    - name: Checkout code
      uses: actions/checkout@v4

    # SSH into EC2 and deploy project
    - name: Deploy via SSH to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.AWS_EC2_HOST }}
        username: ${{ secrets.AWS_EC2_USER }}
        key: ${{ secrets.AWS_EC2_KEY }}
        script: |
          echo "üöÄ Deploying code to EC2..."

          # Go to project folder or clone if not exists
          if [ ! -d /home/ubuntu/todolist-backend ]; then
            echo "üì¶ Cloning project..."
            git clone https://github.com/username/repo.git /home/ubuntu/todolist-backend
          fi

          # Pull latest code
          cd /home/ubuntu/todolist-backend
          git pull origin main
          echo "‚úÖ Pull latest code success"

          # Build Golang Project on EC2
          go mod tidy
          go build -o todolist-backend ./cmd/main.go
          echo "‚úÖ Build successful"

          # Restart Service
          sudo systemctl restart todolist-backend.service
          sleep 3

          # Check service running
          if systemctl is-active --quiet todolist-backend.service; then
            echo "‚úÖ Deploy Successful"
          else
            echo "‚ùå Deploy Failed"
            exit 1
          fi
